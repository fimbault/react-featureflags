{"version":3,"file":"index.es.js","sources":["../src/components/useDocumentVisibility.tsx","../src/components/useEventListener.tsx","../src/components/runtimeConfig.ts","../src/components/FeatureFlags.tsx","../node_modules/unfetch/dist/unfetch.mjs"],"sourcesContent":["import * as React from 'react'\nimport useEventListener from './useEventListener'\n\nfunction getDocument () {\n  const anyGlobal: any = global\n  return anyGlobal.document || {}\n}\n\nfunction getVisibilityPropertyNames () {\n  const document = getDocument()\n\n  if (typeof document.hidden !== 'undefined') {\n    return ['hidden', 'visibilitychange']\n  }\n\n  if (typeof document.msHidden !== 'undefined') {\n    return ['msHidden', 'msvisibilitychange']\n  }\n\n  if (typeof document.webkitHidden !== 'undefined') {\n    return ['webkitHidden', 'webkitvisibilitychange']\n  }\n\n  return ['hidden', 'visibilitychange']\n}\n\nfunction isDocumentHidden (hiddenProp: string) {\n  return !!getDocument()[hiddenProp]\n}\n\nexport function useDocumentVisibilityChange (callback: any) {\n  const [hidden, visibilityChange] = getVisibilityPropertyNames()\n  const onChange = React.useCallback(() => {\n    callback(isDocumentHidden(hidden))\n  }, [callback])\n  useEventListener(visibilityChange, onChange, getDocument())\n}\n\nexport function useDocumentVisibility () {\n  const [hidden] = getVisibilityPropertyNames()\n  const [isHidden, setHidden] = React.useState(isDocumentHidden(hidden))\n  const onChange = React.useCallback(state => setHidden(state), [setHidden])\n  useDocumentVisibilityChange(onChange)\n  return isHidden\n}\n","import * as React from 'react'\n\nfunction useEventListener (eventName: string, handler: any, element: any) {\n  const savedCallback = React.useRef()\n\n  React.useEffect(() => {\n    savedCallback.current = handler\n  }, [handler])\n\n  React.useEffect(() => {\n    // Make sure element supports addEventListener\n\n    const isSupported = element && element.addEventListener\n    if (!isSupported) {\n      return\n    }\n\n    const eventListener = (event: any) => {\n      if (savedCallback) {\n        // @ts-ignore\n        savedCallback.current(event)\n      }\n    }\n\n    element.addEventListener(eventName, eventListener)\n\n    // eslint-disable-next-line consistent-return\n    return () => {\n      element.removeEventListener(eventName, eventListener)\n    }\n  }, [eventName, element])\n}\n\nexport default useEventListener\n","import { Flags } from './FeatureFlags'\n\nlet featureFlags: any\n\nexport function getRuntimeFeatureFlags () {\n  return (featureFlags && featureFlags.flags) || null\n}\n\nexport function getRuntimeEnvironment () {\n  return (featureFlags && featureFlags.environment) || null\n}\n\nexport function getRuntimeNamespace () {\n  return (featureFlags && featureFlags.namespace) || null\n}\n\nexport function setRuntimeFeatureFlags (flags: Flags) {\n  featureFlags = flags\n}\n","import * as React from 'react'\nimport fetch from 'unfetch'\nimport { useDocumentVisibilityChange } from './useDocumentVisibility'\nimport { setRuntimeFeatureFlags } from './runtimeConfig'\n\nexport interface FeatureFlagsProviderProps {\n  clientID: string\n  namespace: string\n  featureFlagsAPI?: string\n  uniqueID?: string\n  fetchInterval?: number\n  logging?: (flags: Flags) => any\n  children: React.ReactNode\n}\n\nexport const useInterval = (callback: () => any, delay: number | null) => {\n  const savedCallback = React.useRef<any>()\n\n  React.useEffect(() => {\n    savedCallback.current = callback\n  })\n\n  React.useEffect(() => {\n    function tick () {\n      savedCallback.current && savedCallback.current()\n    }\n\n    if (delay !== null) {\n      const id = setInterval(tick, delay)\n\n      return () => clearTimeout(id)\n    }\n\n    return undefined\n  }, [delay])\n}\n\nexport interface Flags {\n  [key: string]: any\n}\nexport interface FeatureFlagsContextProps {\n  flags: Flags\n  setUniqueID: (uid: string) => any\n}\n\nexport const FeatureFlagsContext = React.createContext<FeatureFlagsContextProps | null>(\n  null\n)\n\nconst flagDiff = (a: Flags, b: Flags): Flags => {\n  return Object.keys(b).reduce((acc, key) => {\n    if (a[key] !== b[key]) {\n      acc[key] = b[key]\n    }\n\n    return acc\n  }, {})\n}\n\nfunction isObjectEmpty (obj: any) {\n  for (let key in obj) {\n    if (obj.hasOwnProperty(key)) {\n      return false\n    }\n  }\n\n  return true\n}\n\nconst MINIMUM_INTERVAL = 30000\n\nexport interface GetFeatureFlagsParams {\n  clientID: string\n  namespace: string\n  environment?: string\n  featureFlagsAPI?: string\n  uniqueID?: string\n}\n\nexport const getFeatureFlags = ({\n  clientID,\n  namespace,\n  environment,\n  featureFlagsAPI,\n  uniqueID\n}: GetFeatureFlagsParams) =>\n  fetch(\n    `${featureFlagsAPI ||\n      'https://resolver.twoflags.io'}/?account=${clientID}&ns=${namespace}${(environment\n      ? '&env=' + environment\n      : '') + (uniqueID ? '&uid=' + uniqueID : '')}`\n  ).then(res => res.json())\n\nconst getInterval = (interval?: number) => {\n  if (!interval || (interval && interval < MINIMUM_INTERVAL)) {\n    return MINIMUM_INTERVAL\n  }\n\n  return interval\n}\n\nexport const FeatureFlagsProvider: React.FC<FeatureFlagsProviderProps> = ({\n  clientID,\n  namespace,\n  featureFlagsAPI,\n  uniqueID,\n  fetchInterval,\n  logging,\n  children\n}) => {\n  const [data, setData] = React.useState<any>(null)\n  const [interval, setInterval] = React.useState<number | null>(null)\n  const [internalUniqueID, setInternalUniqueID] = React.useState(uniqueID)\n\n  const getFlags = () =>\n    getFeatureFlags({\n      clientID,\n      namespace,\n      featureFlagsAPI,\n      uniqueID: internalUniqueID\n    }).then(nextData => {\n      if (!data) {\n        setData(nextData)\n        setRuntimeFeatureFlags(nextData)\n      } else {\n        const diff = flagDiff(data, nextData)\n        if (!isObjectEmpty(diff)) {\n          const newData = Object.assign({}, data, diff)\n          setData(newData)\n          setRuntimeFeatureFlags(newData)\n        }\n      }\n    })\n\n  useDocumentVisibilityChange((invisible: boolean) => {\n    setInterval(null)\n    if (!invisible) {\n      getFlags().then(() => setInterval(getInterval(fetchInterval)))\n    }\n  })\n\n  React.useEffect(() => {\n    if (logging && data) {\n      logging(data)\n    }\n  }, [data])\n\n  React.useEffect(() => {\n    getFlags()\n    setInterval(getInterval(fetchInterval))\n  }, [internalUniqueID])\n\n  useInterval(() => getFlags(), interval)\n\n  const handleUpdateUniqueID = (uid: string) => {\n    setInternalUniqueID(uid)\n  }\n\n  if (!data) {\n    return null\n  }\n\n  return (\n    <FeatureFlagsContext.Provider\n      value={{ flags: data, setUniqueID: handleUpdateUniqueID }}\n    >\n      {children}\n    </FeatureFlagsContext.Provider>\n  )\n}\n\nexport const useFeatureFlags = () => {\n  const flagsContext = React.useContext(FeatureFlagsContext)\n  if (!flagsContext) {\n    return flagsContext\n  }\n\n  return flagsContext.flags.flags\n}\n\nexport const useFeatureFlagsEnvironment = () => {\n  const flagsContext = React.useContext(FeatureFlagsContext)\n  if (!flagsContext) {\n    return flagsContext\n  }\n\n  return flagsContext.flags.environment\n}\n\nexport const useFeatureFlagsNamespace = () => {\n  const flagsContext = React.useContext(FeatureFlagsContext)\n  if (!flagsContext) {\n    return flagsContext\n  }\n\n  return flagsContext.flags.namespace\n}\n\nexport const useFeatureFlagsUniqueIDUpdater = () => {\n  const flagsContext = React.useContext(FeatureFlagsContext)\n  if (!flagsContext) {\n    return flagsContext\n  }\n\n  return flagsContext.setUniqueID\n}\n","export default function(e,n){return n=n||{},new Promise(function(t,r){var s=new XMLHttpRequest,o=[],u=[],i={},a=function(){return{ok:2==(s.status/100|0),statusText:s.statusText,status:s.status,url:s.responseURL,text:function(){return Promise.resolve(s.responseText)},json:function(){return Promise.resolve(JSON.parse(s.responseText))},blob:function(){return Promise.resolve(new Blob([s.response]))},clone:a,headers:{keys:function(){return o},entries:function(){return u},get:function(e){return i[e.toLowerCase()]},has:function(e){return e.toLowerCase()in i}}}};for(var l in s.open(n.method||\"get\",e,!0),s.onload=function(){s.getAllResponseHeaders().replace(/^(.*?):[^\\S\\n]*([\\s\\S]*?)$/gm,function(e,n,t){o.push(n=n.toLowerCase()),u.push([n,t]),i[n]=i[n]?i[n]+\",\"+t:t}),t(a())},s.onerror=r,s.withCredentials=\"include\"==n.credentials,n.headers)s.setRequestHeader(l,n.headers[l]);s.send(n.body||null)})}\n//# sourceMappingURL=unfetch.mjs.map\n"],"names":["getDocument","global","document","useDocumentVisibilityChange","callback","eventName","handler","element","savedCallback","_a","hidden","msHidden","webkitHidden","visibilityChange","onChange","React.useCallback","hiddenProp","React.useRef","React.useEffect","current","addEventListener","eventListener","event","removeEventListener","featureFlags","getRuntimeFeatureFlags","flags","getRuntimeEnvironment","environment","getRuntimeNamespace","namespace","setRuntimeFeatureFlags","useInterval","delay","id_1","setInterval","clearTimeout","FeatureFlagsContext","React.createContext","getFeatureFlags","e","n","clientID","featureFlagsAPI","uniqueID","Promise","t","r","s","XMLHttpRequest","o","u","i","a","ok","status","statusText","url","responseURL","text","resolve","responseText","json","JSON","parse","blob","Blob","response","clone","headers","keys","entries","get","toLowerCase","has","l","open","method","onload","getAllResponseHeaders","replace","push","onerror","withCredentials","credentials","setRequestHeader","send","body","then","res","getInterval","interval","FeatureFlagsProvider","fetchInterval","logging","children","_b","data","setData","_c","_d","internalUniqueID","setInternalUniqueID","getFlags","nextData","diff","b","Object","reduce","acc","key","obj","hasOwnProperty","isObjectEmpty","newData","assign","invisible","React.createElement","Provider","value","setUniqueID","uid","useFeatureFlags","flagsContext","React.useContext"],"mappings":"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"}
{"version":3,"file":"index.js","sources":["../src/components/runtimeConfig.ts","../src/components/useDocumentVisibility.tsx","../src/components/useEventListener.tsx","../src/components/FeatureFlags.tsx","../node_modules/unfetch/dist/unfetch.mjs"],"sourcesContent":["import { Flags } from './FeatureFlags'\n\nlet featureFlags: any\n\nexport function getRuntimeFeatureFlags () {\n  return (featureFlags && featureFlags.flags) || null\n}\n\nexport function getRuntimeEnvironment () {\n  return (featureFlags && featureFlags.environment) || null\n}\n\nexport function getRuntimeNamespace () {\n  return (featureFlags && featureFlags.namespace) || null\n}\n\nexport function setRuntimeFeatureFlags (flags: Flags) {\n  featureFlags = flags\n}\n","import * as React from 'react'\nimport useEventListener from './useEventListener'\n\nfunction getDocument () {\n  const anyGlobal: any = global\n  return anyGlobal.document || {}\n}\n\nfunction getVisibilityPropertyNames () {\n  const document = getDocument()\n\n  if (typeof document.hidden !== 'undefined') {\n    return ['hidden', 'visibilitychange']\n  }\n\n  if (typeof document.msHidden !== 'undefined') {\n    return ['msHidden', 'msvisibilitychange']\n  }\n\n  if (typeof document.webkitHidden !== 'undefined') {\n    return ['webkitHidden', 'webkitvisibilitychange']\n  }\n\n  return ['hidden', 'visibilitychange']\n}\n\nfunction isDocumentHidden (hiddenProp: string) {\n  return !!getDocument()[hiddenProp]\n}\n\nexport function useDocumentVisibilityChange (callback: any) {\n  const [hidden, visibilityChange] = getVisibilityPropertyNames()\n  const onChange = React.useCallback(() => {\n    callback(isDocumentHidden(hidden))\n  }, [callback])\n  useEventListener(visibilityChange, onChange, getDocument())\n}\n\nexport function useDocumentVisibility () {\n  const [hidden] = getVisibilityPropertyNames()\n  const [isHidden, setHidden] = React.useState(isDocumentHidden(hidden))\n  const onChange = React.useCallback(state => setHidden(state), [setHidden])\n  useDocumentVisibilityChange(onChange)\n  return isHidden\n}\n","import * as React from 'react'\n\nfunction useEventListener (eventName: string, handler: any, element: any) {\n  const savedCallback = React.useRef()\n\n  React.useEffect(() => {\n    savedCallback.current = handler\n  }, [handler])\n\n  React.useEffect(() => {\n    // Make sure element supports addEventListener\n\n    const isSupported = element && element.addEventListener\n    if (!isSupported) {\n      return\n    }\n\n    const eventListener = (event: any) => {\n      if (savedCallback) {\n        // @ts-ignore\n        savedCallback.current(event)\n      }\n    }\n\n    element.addEventListener(eventName, eventListener)\n\n    // eslint-disable-next-line consistent-return\n    return () => {\n      element.removeEventListener(eventName, eventListener)\n    }\n  }, [eventName, element])\n}\n\nexport default useEventListener\n","import * as React from 'react'\nimport fetch from 'unfetch'\nimport { useDocumentVisibilityChange } from './useDocumentVisibility'\nimport { setRuntimeFeatureFlags } from './runtimeConfig'\n\nexport interface FeatureFlagsProviderProps {\n  clientID: string\n  namespace: string\n  featureFlagsAPI?: string\n  uniqueID?: string\n  fetchInterval?: number\n  logging?: (flags: Flags) => any\n  children: React.ReactNode\n}\n\nexport const useInterval = (callback: () => any, delay: number | null) => {\n  const savedCallback = React.useRef<any>()\n\n  React.useEffect(() => {\n    savedCallback.current = callback\n  })\n\n  React.useEffect(() => {\n    function tick () {\n      savedCallback.current && savedCallback.current()\n    }\n\n    if (delay !== null) {\n      const id = setInterval(tick, delay)\n\n      return () => clearTimeout(id)\n    }\n\n    return undefined\n  }, [delay])\n}\n\nexport interface Flags {\n  [key: string]: any\n}\nexport interface FeatureFlagsContextProps {\n  flags: Flags\n  setUniqueID: (uid: string) => any\n}\n\nexport const FeatureFlagsContext = React.createContext<FeatureFlagsContextProps | null>(\n  null\n)\n\nconst flagDiff = (a: Flags, b: Flags): Flags => {\n  return Object.keys(b).reduce((acc, key) => {\n    if (a[key] !== b[key]) {\n      acc[key] = b[key]\n    }\n\n    return acc\n  }, {})\n}\n\nfunction isObjectEmpty (obj: any) {\n  for (let key in obj) {\n    if (obj.hasOwnProperty(key)) {\n      return false\n    }\n  }\n\n  return true\n}\n\nconst MINIMUM_INTERVAL = 30000\n\nexport interface GetFeatureFlagsParams {\n  clientID: string\n  namespace: string\n  environment?: string\n  featureFlagsAPI?: string\n  uniqueID?: string\n}\n\nexport const getFeatureFlags = ({\n  clientID,\n  namespace,\n  environment,\n  featureFlagsAPI,\n  uniqueID\n}: GetFeatureFlagsParams) =>\n  fetch(\n    `${featureFlagsAPI ||\n      'https://resolver.twoflags.io'}/?account=${clientID}&ns=${namespace}${(environment\n      ? '&env=' + environment\n      : '') + (uniqueID ? '&uid=' + uniqueID : '')}`\n  ).then(res => res.json())\n\nconst getInterval = (interval?: number) => {\n  if (!interval || (interval && interval < MINIMUM_INTERVAL)) {\n    return MINIMUM_INTERVAL\n  }\n\n  return interval\n}\n\nexport const FeatureFlagsProvider: React.FC<FeatureFlagsProviderProps> = ({\n  clientID,\n  namespace,\n  featureFlagsAPI,\n  uniqueID,\n  fetchInterval,\n  logging,\n  children\n}) => {\n  const [data, setData] = React.useState<any>(null)\n  const [interval, setInterval] = React.useState<number | null>(null)\n  const [internalUniqueID, setInternalUniqueID] = React.useState(uniqueID)\n\n  const getFlags = () =>\n    getFeatureFlags({\n      clientID,\n      namespace,\n      featureFlagsAPI,\n      uniqueID: internalUniqueID\n    }).then(nextData => {\n      if (!data) {\n        setData(nextData)\n        setRuntimeFeatureFlags(nextData)\n      } else {\n        const diff = flagDiff(data, nextData)\n        if (!isObjectEmpty(diff)) {\n          const newData = Object.assign({}, data, diff)\n          setData(newData)\n          setRuntimeFeatureFlags(newData)\n        }\n      }\n    })\n\n  useDocumentVisibilityChange((invisible: boolean) => {\n    setInterval(null)\n    if (!invisible) {\n      getFlags().then(() => setInterval(getInterval(fetchInterval)))\n    }\n  })\n\n  React.useEffect(() => {\n    if (logging && data) {\n      logging(data)\n    }\n  }, [data])\n\n  React.useEffect(() => {\n    getFlags()\n    setInterval(getInterval(fetchInterval))\n  }, [internalUniqueID])\n\n  useInterval(() => getFlags(), interval)\n\n  const handleUpdateUniqueID = (uid: string) => {\n    setInternalUniqueID(uid)\n  }\n\n  if (!data) {\n    return null\n  }\n\n  return (\n    <FeatureFlagsContext.Provider\n      value={{ flags: data, setUniqueID: handleUpdateUniqueID }}\n    >\n      {children}\n    </FeatureFlagsContext.Provider>\n  )\n}\n\nexport const useFeatureFlags = () => {\n  const flagsContext = React.useContext(FeatureFlagsContext)\n  if (!flagsContext) {\n    return flagsContext\n  }\n\n  return flagsContext.flags.flags\n}\n\nexport const useFeatureFlagsEnvironment = () => {\n  const flagsContext = React.useContext(FeatureFlagsContext)\n  if (!flagsContext) {\n    return flagsContext\n  }\n\n  return flagsContext.flags.environment\n}\n\nexport const useFeatureFlagsNamespace = () => {\n  const flagsContext = React.useContext(FeatureFlagsContext)\n  if (!flagsContext) {\n    return flagsContext\n  }\n\n  return flagsContext.flags.namespace\n}\n\nexport const useFeatureFlagsUniqueIDUpdater = () => {\n  const flagsContext = React.useContext(FeatureFlagsContext)\n  if (!flagsContext) {\n    return flagsContext\n  }\n\n  return flagsContext.setUniqueID\n}\n","export default function(e,n){return n=n||{},new Promise(function(t,r){var s=new XMLHttpRequest,o=[],u=[],i={},a=function(){return{ok:2==(s.status/100|0),statusText:s.statusText,status:s.status,url:s.responseURL,text:function(){return Promise.resolve(s.responseText)},json:function(){return Promise.resolve(JSON.parse(s.responseText))},blob:function(){return Promise.resolve(new Blob([s.response]))},clone:a,headers:{keys:function(){return o},entries:function(){return u},get:function(e){return i[e.toLowerCase()]},has:function(e){return e.toLowerCase()in i}}}};for(var l in s.open(n.method||\"get\",e,!0),s.onload=function(){s.getAllResponseHeaders().replace(/^(.*?):[^\\S\\n]*([\\s\\S]*?)$/gm,function(e,n,t){o.push(n=n.toLowerCase()),u.push([n,t]),i[n]=i[n]?i[n]+\",\"+t:t}),t(a())},s.onerror=r,s.withCredentials=\"include\"==n.credentials,n.headers)s.setRequestHeader(l,n.headers[l]);s.send(n.body||null)})}\n//# sourceMappingURL=unfetch.mjs.map\n"],"names":["featureFlags","getDocument","global","document","useDocumentVisibilityChange","callback","eventName","handler","element","savedCallback","_a","hidden","msHidden","webkitHidden","visibilityChange","onChange","React.useCallback","hiddenProp","React.useRef","React.useEffect","current","addEventListener","eventListener","event","removeEventListener","setRuntimeFeatureFlags","flags","useInterval","delay","id_1","setInterval","clearTimeout","FeatureFlagsContext","React.createContext","getFeatureFlags","e","n","clientID","namespace","environment","featureFlagsAPI","uniqueID","Promise","t","r","s","XMLHttpRequest","o","u","i","a","ok","status","statusText","url","responseURL","text","resolve","responseText","json","JSON","parse","blob","Blob","response","clone","headers","keys","entries","get","toLowerCase","has","l","open","method","onload","getAllResponseHeaders","replace","push","onerror","withCredentials","credentials","setRequestHeader","send","body","then","res","getInterval","interval","fetchInterval","logging","children","_b","data","setData","_c","_d","internalUniqueID","setInternalUniqueID","getFlags","nextData","diff","b","Object","reduce","acc","key","obj","hasOwnProperty","isObjectEmpty","newData","assign","invisible","React.createElement","Provider","value","setUniqueID","uid","flagsContext","React.useContext"],"mappings":"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"}